(include "././array/class.inc")

(def-class nums array
	(dec-method :vtable class/nums/vtable)
	(dec-method :hash class/nums/hash :override)
	(dec-method :vcreate class/nums/create :override)
	(dec-method :add class/nums/add :virtual (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :sub class/nums/sub :virtual (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :mul class/nums/mul :virtual (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :div class/nums/div :virtual (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :mod class/nums/mod :virtual (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :abs class/nums/abs :virtual (:r0 :r1) (:r0))
	(dec-method :sum class/nums/sum :virtual (:r0) (:r0 :r1))
	(dec-method :scale class/nums/scale :virtual (:r0 :r1 :r2) (:r0))
	(dec-method :min class/nums/min :virtual (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :max class/nums/max :virtual (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :dot class/nums/dot :virtual (:r0 :r1) (:r0 :r1))
	(dec-method :create class/nums/create)
	(dec-method :lisp_vecop1 class/nums/lisp_vecop1 :static (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :lisp_vecop2 class/nums/lisp_vecop2 :static (:r0 :r1 :r2) (:r0 :r1))
	(dec-method :lisp_add class/nums/lisp_add :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_sub class/nums/lisp_sub :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_mul class/nums/lisp_mul :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_div class/nums/lisp_div :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_mod class/nums/lisp_mod :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_sum class/nums/lisp_sum :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_dot class/nums/lisp_dot :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_scale class/nums/lisp_scale :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_min class/nums/lisp_min :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_max class/nums/lisp_max :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_abs class/nums/lisp_abs :static (:r0 :r1) (:r0 :r1)))

(def-struct nums array_size)

;;;;;;;;;;;;;;;;;;;;;
; inline vector loops
;;;;;;;;;;;;;;;;;;;;;

(defun vec-loop-until (srcs elms end dst func)
	(loop-start)
		(each (# (assign (list (list %0 0)) (list %1))) srcs elms)
		(each (# (vp-add-cr +long_size %0)) srcs)
		(defq r (apply func elms))
		(when dst
			(assign (list r) (list (list dst 0)))
			(vp-add-cr +long_size dst))
	(loop-until `(,(first srcs) = ,end)))

(defun vec-loop-while (srcs elms end dst func)
	(vpif `(,(first srcs) /= ,end))
		(vec-loop-until srcs elms end dst func)
	(endif))

(defun vec-map (sobs dobs elms sitrs ditrs eitr func &optional fpre fpost)
	(assign `((,(first sobs) array_length)) `(,eitr))
	(vp-simd vp-cpy-ir (cat sobs dobs) (list array_begin) (cat sitrs ditrs))
	(vp-shl-cr (log2 +ptr_size) eitr)
	(vp-add-rr (first sitrs) eitr)
	(if fpre (fpre))
	(vec-loop-until sitrs elms eitr (first ditrs) func)
	(if fpost (fpost)))

(defun vec-reduce (sobs elms sitrs eitr func &optional fpre fpost)
	(assign `((,(first sobs) array_length)) `(,eitr))
	(vp-simd vp-cpy-ir sobs (list array_begin) sitrs)
	(vp-shl-cr (log2 +ptr_size) eitr)
	(vp-add-rr (first sitrs) eitr)
	(if fpre (fpre))
	(vec-loop-until sitrs elms eitr :nil func)
	(if fpost (fpost)))

(defun vec-loop-until-idx (srcs elms idxs dst func)
	(loop-start)
		(each (# (assign (list (list %0 (first idxs))) (list %1))) srcs elms)
		(defq r (apply func elms))
		(if dst (assign (list r) (list (list dst (first idxs)))))
		(vp-add-cr +long_size (first idxs))
	(loop-until `(,(first idxs) = ,(last idxs))))

(defun vec-map-idx (sobs dobs elms sitrs ditrs idxs func &optional fpre fpost)
	(assign `((,(first sobs) array_length)) `(,(last idxs)))
	(vp-simd vp-cpy-ir (cat sobs dobs) (list array_begin) (cat sitrs ditrs))
	(vp-xor-rr (first idxs) (first idxs))
	(vp-shl-cr (log2 +ptr_size) (last idxs))
	(if fpre (fpre))
	(vec-loop-until-idx sitrs elms idxs (first ditrs) func)
	(if fpost (fpost)))

(defun vec-reduce-idx (sobs elms sitrs idxs func &optional fpre fpost)
	(assign `((,(first sobs) array_length)) `(,(last idxs)))
	(vp-simd vp-cpy-ir sobs (list array_begin) sitrs)
	(vp-xor-rr (first idxs) (first idxs))
	(vp-shl-cr (log2 +ptr_size) (last idxs))
	(if fpre (fpre))
	(vec-loop-until-idx sitrs elms idxs :nil func)
	(if fpost (fpost)))
