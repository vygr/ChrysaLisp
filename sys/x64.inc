;;;;;;;;;;;;;;;;;;;;
; x64 Emit Functions
;;;;;;;;;;;;;;;;;;;;

(defcfun reg (r)
	(find r '(r0 r1 r2 r3 rsp r4 r5 r6 r7 r8 r9 r10 r11 r12 r13 r14)))

(defcvar 'stack_align 8 'stack_state '(r0 r1 r2 r3 r4 r5 r6 r7 r8 r9 r10 r11 r12 r13 r14))
(defcfun stack-init ()
	(defq tk_state_size (mul ptr_size (length stack_state)))
	(vp-sub-cr (add tk_state_size (mul ptr_size 2)) r1)
	(f-bind 'sys_task 'stop r2)
	(vp-cpy-ri r2 r1 (add tk_state_size ptr_size))
	(vp-cpy-ri r4 r1 tk_state_size))

(defcfun emit-alloc (c) (emit-sub-cr (align c stack_align) rsp))
(defcfun emit-free (c) (emit-add-cr (align c stack_align) rsp))
(defcfun emit-ret () (emit-byte 0xc3))

(defcfun emit-rr (o s d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl sh 2) dh) o (add 0xc0 (bit-shl sl 3) dl)))

(defcfun emit-dr (o s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h) o)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-dr-bs (o s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h) 0xf o)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-ir (o s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) o)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-ir constant out of range" c))))

(defcfun emit-ir-bs (o s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) 0x0f o)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-ir-bs constant out of range" c))))

(defcfun emit-pr (o c d)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl dh 2)) o (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (throw "emit-pr constant out of range" c))))

(defcfun emit-shift-cr (o c d)
	(unless (eq c 0)
		(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
		(emit-byte (add 0x48 dh))
		(cond
			((eq c 1)
				(emit-byte 0xd1 (add o dl)))
			((le c 0xff)
				(emit-byte 0xc1 (add o dl) c))
			(t (throw "emit-shift-cr constant out of range" c)))))

(defcfun emit-shift-rr (o s d)
	(cond
		((eql s r1)
			(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
			(emit-byte (add 0x48 dh) 0xd3 (add o dl)))
		((eql d r1)
			(defq sn (reg s) sl (bit-and 7 sn) sh (bit-shr sn 3))
			(emit-swp-rr s d)
			(emit-byte (add 0x48 sh) 0xd3 (add o sl))
			(emit-swp-rr s d))
		(t
			(emit-push d s r0 r1)
			(emit-cpy-ir rsp 24 r0)
			(emit-cpy-ir rsp 16 r1)
			(emit-byte 0x48 0xd3 o)
			(emit-cpy-ri r0 rsp 24)
			(emit-pop d s r0 r1))))

(defcfun emit-call-jump-p (o c)
	(emit-byte 0xff o)
	(emit-int (sub c 6)))

(defcfun emit-call-jump-r (o d)
	(defq d (reg d) dl (bit-and 7 d))
	(if (ge d 8) (emit-byte 0x41))
	(emit-byte 0xff (add o dl)))

(defcfun emit-call-jump-i (o d c)
	(defq d (reg d) dl (bit-and 7 d))
	(if (ge d 8) (emit-byte 0x41))
	(emit-byte 0xff)
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add o dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 o dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 o dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-call-jump-i constant out of range" c))))

(defcfun emit-push (&rest b)
	(each (lambda (r)
		(if (ge (setq r (reg r)) 8)
			(emit-byte 0x41 (add 0x48 r))
			(emit-byte (add 0x50 r)))) b))

(defcfun emit-pop (&rest b)
	(each-rev (lambda (r)
		(if (ge (setq r (reg r)) 8)
			(emit-byte 0x41 (add 0x50 r))
			(emit-byte (add 0x58 r)))) b))

(defcfun emit-branch (o c d)
	(defq m (elem d *distance*))
	(and (ne *pass* 0) (gt (abs c) (abs m)) (elem-set d *distance* (setq m c)))
	(cond
		((le -0x80 (sub m 2) 0x7f)
			(emit-byte o (sub c 2)))
		((le -0x80000000 (sub m 6) 0x7fffffff)
			(emit-byte 0xf (add 0x10 o))
			(emit-int (sub c 6)))
		(t (throw "emit-branch constant out of range" c))))

(defcfun emit-syscall ()
	(emit-byte 0xf 0x5))

(defcfun emit-beq (l d) (emit-branch 0x74 (sub l *pc*) d))
(defcfun emit-bne (l d) (emit-branch 0x75 (sub l *pc*) d))
(defcfun emit-blt (l d) (emit-branch 0x7c (sub l *pc*) d))
(defcfun emit-ble (l d) (emit-branch 0x7e (sub l *pc*) d))
(defcfun emit-bgt (l d) (emit-branch 0x7f (sub l *pc*) d))
(defcfun emit-bge (l d) (emit-branch 0x7d (sub l *pc*) d))

(defcfun emit-call (l)
	(cond
		((le -0x80000000 (defq c (sub l *pc* 5)) 0x7fffffff)
			(emit-byte 0xe8)
			(emit-int c))
		(t (throw "emit-call constant out of range" c))))

(defcfun emit-call-r (r) (emit-call-jump-r 0xd0 r))
(defcfun emit-call-i (d c) (emit-call-jump-i 0x10 d c))
(defcfun emit-call-p (l) (emit-call-jump-p 0x15 (sub l *pc*)))

(defcfun emit-jmp (l d)
	(defq m (elem d *distance*) c (sub l *pc*))
	(and (ne *pass* 0) (gt (abs c) (abs m)) (elem-set d *distance* (setq m c)))
	(cond
		((le -0x80 (sub m 2) 0x7f)
			(emit-byte (add 0x2 0xe9) (sub c 2)))
		((le -0x80000000 (sub m 5) 0x7fffffff)
			(emit-byte 0xe9)
			(emit-int (sub c 5)))
		(t (throw "emit-jmp constant out of range" c))))

(defcfun emit-jmp-r (r) (emit-call-jump-r 0xe0 r))
(defcfun emit-jmp-i (d c) (emit-call-jump-i 0x20 d c))
(defcfun emit-jmp-p (l) (emit-call-jump-p 0x25 (sub l *pc*)))

(defcfun emit-lea-i (s c d) (emit-ir 0x8d s c d))
(defcfun emit-lea-d (s1 s2 d) (emit-dr 0x8d s1 s2 d))
(defcfun emit-lea-p (l d) (emit-pr 0x8d (sub l *pc*) d))

(defcfun emit-cpy-cr (c r)
	(if (eq c 0)
		(emit-xor-rr r r)
		(progn
			(defq rn (reg r) rl (bit-and rn 7) rh (bit-shr rn 3))
			(cond
				((eq -1 c)
					(emit-or-cr -1 r))
				((le 0 c 0xffffffff)
					(if (ge rn 8) (emit-byte 0x41))
					(emit-byte (add 0xb8 rl))
					(emit-int c))
				((le -0x80000000 c -1)
					(emit-byte (add 0x48 rh) 0xc7 (add 0xc0 rl))
					(emit-int c))
				(t
					(emit-byte (add 0x48 rh) (add 0xb8 rl))
					(emit-long c))))))

(defcfun emit-cpy-rr (s d) (unless (eql s d) (emit-rr 0x89 s d)))
(defcfun emit-cpy-ir (s c d) (emit-ir 0x8b s c d))
(defcfun emit-cpy-dr (s1 s2 d) (emit-dr 0x8b s1 s2 d))
(defcfun emit-cpy-pr (l d) (emit-pr 0x8b (sub l *pc*) d))

(defcfun emit-cpy-ri (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x89 (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x89 (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x89 (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-cpy-ri constant out of range " c))))

(defcfun emit-cpy-rd (d s1 s2)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h) 0x89)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-cpy-rp (d l)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub l *pc* 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl dh 2)) 0x89 (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (throw "emit-cpy-rp constant out of range" c))))

(defcfun emit-cpy-ir-b (s c d) (emit-ir-bs 0xbe s c d))
(defcfun emit-cpy-dr-b (s1 s2 d) (emit-dr-bs 0xbe s1 s2 d))
(defcfun emit-cpy-ir-ub (s c d) (emit-ir-bs 0xb6 s c d))
(defcfun emit-cpy-dr-ub (s1 s2 d) (emit-dr-bs 0xb6 s1 s2 d))
(defcfun emit-cpy-ir-s (s c d) (emit-ir-bs 0xbf s c d))
(defcfun emit-cpy-dr-s (s1 s2 d) (emit-dr-bs 0xbf s1 s2 d))
(defcfun emit-cpy-ir-us (s c d) (emit-ir-bs 0xb7 s c d))
(defcfun emit-cpy-dr-us (s1 s2 d) (emit-dr-bs 0xb7 s1 s2 d))

(defcfun emit-cpy-ir-i (s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) 0x63)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-cpy-ir-i constant out of range" c))))

(defcfun emit-cpy-dr-i (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h) 0x63)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-cpy-ir-ui (s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (or (ge s 8) (ge d 8)) (emit-byte (add 0x40 (bit-shl dh 2) sh)))
	(emit-byte 0x8b)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-cpy-ir-ui constant out of range " c))))

(defcfun emit-cpy-dr-ui (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (or (ge s1 8) (ge s2 8) (ge d 8)) (emit-byte (add 0x40 (bit-shl dh 2) (bit-shl s2h 1) s1h)))
	(emit-byte 0x8b)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-cpy-ri-b (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (or (ge s 4) (ge d 8)) (emit-byte (add 0x40 (bit-shl sh 2) dh)))
	(emit-byte 0x88)
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-cpy-ri-b constant out of range" c))))

(defcfun emit-cpy-rd-b (r s1 s2)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(if (or (ge s1 8) (ge s2 8) (ge r 4)) (emit-byte (add 0x40 (bit-shl rh 2) (bit-shl s2h 1) s1h)))
	(emit-byte 0x88)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl rl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl rl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-cpy-ri-s (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte 0x66)
	(if (or (ge s 8) (ge d 8)) (emit-byte (add 0x40 (bit-shl sh 2) dh)))
	(emit-byte 0x89)
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-cpy-ri-s constant out of range" c))))

(defcfun emit-cpy-rd-s (r s1 s2)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte 0x66)
	(if (or (ge s1 8) (ge s2 8) (ge r 8)) (emit-byte (add 0x40 (bit-shl rh 2) (bit-shl s2h 1) s1h)))
	(emit-byte 0x89)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl rl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl rl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-cpy-ri-i (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (or (ge s 8) (ge d 8)) (emit-byte (add 0x40 (bit-shl sh 2) dh)))
	(emit-byte 0x89)
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (throw "emit-cpy-ri-i constant out of range" c))))

(defcfun emit-cpy-rd-i (r s1 s2)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(if (or (ge s1 8) (ge s2 8) (ge r 8)) (emit-byte (add 0x40 (bit-shl rh 2) (bit-shl s2h 1) s1h)))
	(emit-byte 0x89)
	(cond
		((and (ne s1 5) (ne s1 13))
			(emit-byte (add 0x04 (bit-shl rl 3)) (add (bit-shl s2l 3) s1l)))
		(t
			(emit-byte (add 0x44 (bit-shl rl 3)) (add (bit-shl s2l 3) s1l) 0))))

(defcfun emit-add-cr (c r)
	(unless (eq c 0)
		(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
		(emit-byte (add 0x48 rh))
		(cond
			((eq 1 c)
				(emit-byte 0xff (add 0xc0 rl)))
			((le -0x80 c 0x7f)
				(emit-byte 0x83 (add 0xc0 rl) c))
			((le -0x80000000 c 0x7fffffff)
				(if (eq r 0)
					(emit-byte 0x05)
					(emit-byte 0x81 (add 0xc0 rl)))
				(emit-int c))
			(t (throw "emit-add-cr constant out of range" c)))))

(defcfun emit-add-rr (s d) (emit-rr 0x01 s d))

(defcfun emit-sub-cr (c r)
	(unless (eq c 0)
		(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
		(emit-byte (add 0x48 rh))
		(cond
			((eq 1 c)
				(emit-byte 0xff (add 0xc8 rl)))
			((le -0x80 c 0x7f)
				(emit-byte 0x83 (add 0xe8 rl) c))
			((le -0x80000000 c 0x7fffffff)
				(if (eq r 0)
					(emit-byte 0x2d)
					(emit-byte 0x81 (add 0xe8 rl)))
				(emit-int c))
			(t (throw "emit-sub-cr constant out of range" c)))))

(defcfun emit-sub-rr (s d) (emit-rr 0x29 s d))

(defcfun emit-cmp-cr (c r)
	(if (eq c 0) (emit-rr 0x85 r r)
		(progn
			(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
			(emit-byte (add 0x48 rh))
			(cond
				((le -0x80 c 0x7f)
					(emit-byte 0x83 (add 0xf8 rl) c))
				((le -0x80000000 c 0x7fffffff)
					(if (eq r 0)
						(emit-byte 0x3d)
						(emit-byte 0x81 (add 0xf8 rl)))
					(emit-int c))
				(t (throw "emit-cmp-cr constant out of range" c))))))

(defcfun emit-cmp-rr (s d) (emit-rr 0x39 s d))

(defcfun emit-and-cr (c r)
	(unless (eq c -1)
		(if (eq c 0)
			(emit-xor-rr r r)
			(progn
				(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
				(emit-byte (add 0x48 rh))
				(cond
					((le -0x80 c 0x7f)
						(emit-byte 0x83 (add 0xe0 rl) c))
					((le -0x80000000 c 0x7fffffff)
						(if (eq r 0)
							(emit-byte 0x25)
							(emit-byte 0x81 (add 0xe0 rl)))
						(emit-int c))
					(t (throw "emit-and-cr constant out of range" c)))))))

(defcfun emit-and-rr (s d) (unless (eql s d) (emit-rr 0x21 s d)))

(defcfun emit-or-cr (c r)
	(unless (eq c 0)
		(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
		(emit-byte (add 0x48 rh))
		(cond
			((le -0x80 c 0x7f)
				(emit-byte 0x83 (add 0xc8 rl) c))
			((le -0x80000000 c 0x7fffffff)
				(if (eq r 0)
					(emit-byte 0x0d)
					(emit-byte 0x81 (add 0xc8 rl)))
				(emit-int c))
			(t (throw "emit-or-cr constant out of range" c)))))

(defcfun emit-or-rr (s d) (unless (eql s d) (emit-rr 0x09 s d)))

(defcfun emit-xor-cr (c r)
	(unless (eq c 0)
		(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
		(emit-byte (add 0x48 rh))
		(cond
			((le -0x80 c 0x7f)
				(emit-byte 0x83 (add 0xf0 rl) c))
			((le -0x80000000 c 0x7fffffff)
				(if (eq r 0)
					(emit-byte 0x35)
					(emit-byte 0x81 (add 0xf0 rl)))
				(emit-int c))
			(t (throw "emit-xor-cr constant out of range" c)))))

(defcfun emit-xor-rr (s d) (emit-rr 0x31 s d))

(defcfun emit-shl-cr (c r) (emit-shift-cr 0xe0 c r))
(defcfun emit-shl-rr (s d) (emit-shift-rr 0xe0 s d))
(defcfun emit-shr-cr (c r) (emit-shift-cr 0xe8 c r))
(defcfun emit-shr-rr (s d) (emit-shift-rr 0xe8 s d))
(defcfun emit-asr-cr (c r) (emit-shift-cr 0xf8 c r))
(defcfun emit-asr-rr (s d) (emit-shift-rr 0xf8 s d))

(defcfun emit-mul-cr (c r)
	(if (eq c 0)
		(emit-xor-rr r r)
		(progn
			(defq r (reg r) rl (bit-and r 7) rh (bit-shr r 3))
			(cond
				((eq 1 c))
				((eq -1 c)
					(emit-byte (add 0x48 rh) 0xf7 (add 0xd8 rl)))
				((le -0x80 c 0x7f)
					(emit-byte (add 0x48 (bit-shl rh 2) rh) 0x6b (add 0xc0 rl (bit-shl rl 3)) c))
				((le -0x80000000 c 0x7fffffff)
					(emit-byte (add 0x48 (bit-shl rh 2) rh) 0x69 (add 0xc0 rl (bit-shl rl 3)))
					(emit-int c))
				(t (throw "emit-mul-cr constant out of range" c))))))

(defcfun emit-mul-rr (s d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) 0x0f 0xaf (add 0xc0 (bit-shl dl 3) sl)))

(defcfun emit-swp-rr (s d)
	(unless (eql s d)
		(if (eql s r0) (setq s d d r0))
		(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
			d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
		(if (eq d 0)
			(emit-byte (add 0x48 sh) (add 0x90 sl))
			(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x87 (add 0xc0 (bit-shl sl 3) dl)))))

(defcfun emit-ext-rr (s d)
	(cond
		((and (eql s r0) (eql d r2))
			(emit-byte 0x48 0x99))
		((eql s d)
			(emit-asr-cr 63 d))
		(t
			(emit-cpy-rr s d)
			(emit-asr-cr 63 d))))

(defcfun emit-div-rrr (s d1 d2)
	(cond
		((and (eql d1 r2) (eql d2 r0))
			(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3))
			(emit-byte (add 0x48 sh) 0xF7 (add 0xF8 sl)))
		((and (eql d1 r0) (eql d2 r2) (not (eql s r0)) (not (eql s r2)))
			(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3))
			(emit-byte 0x48 0x92 (add 0x48 sh) 0xF7 (add 0xF8 sl) 0x48 0x92))
		(t
			(emit-push d2 d1 s r2 r1 r0)
			(emit-cpy-ir rsp 24 r1)
			(emit-cpy-ir rsp 32 r2)
			(emit-cpy-ir rsp 40 r0)
			(emit-byte 0x48 0xF7 0xF9)
			(emit-cpy-ri r2 rsp 32)
			(emit-cpy-ri r0 rsp 40)
			(emit-pop d2 d1 s r2 r1 r0))))

(defcfun emit-div-rrr-u (s d1 d2)
	(cond
		((and (eql d1 r2) (eql d2 r0))
			(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3))
			(emit-byte (add 0x48 sh) 0xF7 (add 0xF0 sl)))
		((and (eql d1 r0) (eql d2 r2) (not (eql s r0)) (not (eql s r2)))
			(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3))
			(emit-byte 0x48 0x92 (add 0x48 sh) 0xF7 (add 0xF0 sl) 0x48 0x92))
		(t
			(emit-push d2 d1 s r2 r1 r0)
			(emit-cpy-ir rsp 24 r1)
			(emit-cpy-ir rsp 32 r2)
			(emit-cpy-ir rsp 40 r0)
			(emit-byte 0x48 0xF7 0xF1)
			(emit-cpy-ri r2 rsp 32)
			(emit-cpy-ri r0 rsp 40)
			(emit-pop d2 d1 s r2 r1 r0))))
