(include "lib/asm/class.inc")
(include "./struct.inc")
(include "./abi.inc")

(def-class :host_os :nil
	(dec-method :exit :nil :virtual (abi-args 1))
	(dec-method :stat :nil :virtual (abi-args 2) (:r0))
	(dec-method :open :nil :virtual (abi-args 2) (:r0))
	(dec-method :close :nil :virtual (abi-args 1) (:r0))
	(dec-method :unlink :nil :virtual (abi-args 1) (:r0))
	(dec-method :read :nil :virtual (abi-args 3) (:r0))
	(dec-method :write :nil :virtual (abi-args 3) (:r0))
	(dec-method :mmap :nil :virtual (abi-args 3) (:r0))
	(dec-method :munmap :nil :virtual (abi-args 3) (:r0))
	(dec-method :mprotect :nil :virtual (abi-args 3) (:r0))
	(dec-method :gettime :nil :virtual () (:r0))
	(dec-method :open_shared :nil :virtual (abi-args 2) (:r0))
	(dec-method :close_shared :nil :virtual (abi-args 2) (:r0))
	(dec-method :clear_icache :nil :virtual (abi-args 2) (:r0))
	(dec-method :dirlist :nil :virtual (abi-args 3) (:r0))
	(dec-method :remove :nil :virtual (abi-args 1) (:r0))
	(dec-method :seek :nil :virtual (abi-args 3) (:r0))
	(dec-method :rand :nil :virtual (abi-args 2) (:r0))
	(dec-method :sleep :nil :virtual (abi-args 1) (:r0))
	(dec-method :pii_exit sys/pii/exit :static (:r0))
	(dec-method :pii_mmap sys/pii/mmap :static (:r0 :r1 :r2) (:r0))
	(dec-method :pii_munmap sys/pii/munmap :static (:r0 :r1 :r2) (:r0))
	(dec-method :pii_mprotect sys/pii/mprotect :static (:r0 :r1 :r2) (:r0))
	(dec-method :pii_open sys/pii/open :static (:r0 :r1) (:r0))
	(dec-method :pii_close sys/pii/close :static (:r0) (:r0))
	(dec-method :pii_open_shared sys/pii/open_shared :static (:r0 :r1) (:r0))
	(dec-method :pii_close_shared sys/pii/close_shared :static (:r0 :r1) (:r0))
	(dec-method :pii_unlink sys/pii/unlink :static (:r0) (:r0))
	(dec-method :pii_stat sys/pii/stat :static (:r0 :r1) (:r0))
	(dec-method :pii_write sys/pii/write :static (:r0 :r1 :r2) (:r0))
	(dec-method :pii_write_char sys/pii/write_char :static (:r0 :r1) (:r0))
	(dec-method :pii_write_str sys/pii/write_str :static (:r0 :r1) (:r0))
	(dec-method :pii_write_num sys/pii/write_num :static (:r0 :r1 :r2))
	(dec-method :pii_read sys/pii/read :static (:r0 :r1 :r2) (:r0))
	(dec-method :pii_read_char sys/pii/read_char :static (:r0) (:r0))
	(dec-method :pii_time sys/pii/time :static :nil (:r0))
	(dec-method :pii_clear_icache sys/pii/clear_icache :static (:r0 :r1) (:r0))
	(dec-method :pii_dirlist sys/pii/dirlist :static (:r0 :r1 :r2) (:r0))
	(dec-method :pii_remove sys/pii/remove :static (:r0) (:r0))
	(dec-method :pii_seek sys/pii/seek :static (:r0 :r1 :r2) (:r0))
	(dec-method :pii_rand sys/pii/rand :static (:r0 :r1) (:r0))
	(dec-method :pii_flush sys/pii/flush :static (:r0) (:r0))
	(dec-method :lisp_readchar sys/pii/lisp_readchar :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_writechar sys/pii/lisp_writechar :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_time sys/pii/lisp_time :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_age sys/pii/lisp_age :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_dirlist sys/pii/lisp_dirlist :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_fstat sys/pii/lisp_fstat :static (:r0 :r1) (:r0 :r1))
	(dec-method :lisp_remove sys/pii/lisp_remove :static (:r0 :r1) (:r0 :r1)))

(defun abi-call-table (%0 %1 %2 &optional %3 %4 %5)
	;%0 = class name
	;%1 = member name
	;%2 = host function table
	;%3 = in parameters
	;%4 = out parameters
	;%5 = temp reg
	(setd %5 :r13)
	(defq m (method-lookup %0 %1) x (list) s (third m))
	(if (eql (second m) :static)
		(throw "Abi methods must be virtual !" (list %0 %1)))
	(if (or (find %2 s) (find %5 s))
		(throw "Dispatch/Temp register conflicts with arg !" (list %2 %5 s)))
	(assign %3 s)
	(when (> (defq ls (length s)) (defq la (length (abi-args))))
		(setq x (slice s ls la)))
	(vp-call-abi %5 %2 (- (elem-get m 4) +ptr_size) (length s) x)
	(if %4 (assign (elem-get m 3) %4)))

(defun host-os-call (%0 %1 &optional %2 %3 %4 %5)
	;%0 = class name
	;%1 = member name
	;%2 = in parameters
	;%3 = out parameters
	;%4 = dispatch reg
	;%5 = temp reg
	(setd %4 :r14 %5 :r13)
	(fn-bind 'sys/statics/statics %4)
	(vp-cpy-ir %4 statics_sys_load_host_os_funcs %4)
	(abi-call-table %0 %1 %4 %2 %3 %5))

;debug helpers
(defun debug-num (s n)
	(when (> *build_mode* 0)
		(def-vars
			(ptr _a _b _c))
		(push-scope)
		(assign '(:r0 :r1 :r2) {_a, _b, _c})
		(fn-string (cat s ": ") :r1)
		(call :host_os :pii_write_str '(2 :r1))
		(assign {_a, _b, _c} '(:r0 :r1 :r2))
		(assign n '(:r1))
		(call :host_os :pii_write_num '(2 :r1 16))
		(call :host_os :pii_write_char '(2 10))
		(assign {_a, _b, _c} '(:r0 :r1 :r2))
		(pop-scope)))

(defun debug-str (s)
	(when (> *build_mode* 0)
		(def-vars
			(ptr _a _b))
		(push-scope)
		(assign '(:r0 :r1) {_a, _b})
		(assign s '(:r1))
		(call :host_os :pii_write_str '(2 :r1))
		(call :host_os :pii_write_char '(2 10))
		(assign {_a, _b} '(:r0 :r1))
		(pop-scope)))

(defcvar 's_ifmt 0xf000)
(defcvar 's_ifdir 0x4000)
(defcvar 's_ifreg 0x8000)
